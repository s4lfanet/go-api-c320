# Development Docker Compose Configuration (DEFAULT)
# Builds from source with hot-reload support (Air)
#
# Setup:
#   1. Copy .env.example to .env
#   2. Edit .env with your credentials
#   3. Run: docker compose up --build
#
# Features:
#   - Hot reload with Air
#   - Volume mount for live code changes
#   - Debug-friendly configuration

services:
  app:
    restart: always
    container_name: go-snmp-olt-zte-c320-dev
    build:
      context: .
      target: dev
      dockerfile: Dockerfile

    command: air -c .air.toml

    environment:
      # Application
      APP_ENV: ${APP_ENV:-development}

      # Server
      SERVER_HOST: ${SERVER_HOST:-0.0.0.0}
      SERVER_PORT: ${SERVER_PORT:-8081}

      # SNMP Configuration
      SNMP_HOST: ${SNMP_HOST}
      SNMP_PORT: ${SNMP_PORT:-161}
      SNMP_COMMUNITY: ${SNMP_COMMUNITY}

      # Redis (use Docker service name)
      REDIS_HOST: redis
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REDIS_DB: ${REDIS_DB:-0}
      REDIS_MIN_IDLE_CONNECTIONS: ${REDIS_MIN_IDLE_CONNECTIONS:-200}
      REDIS_POOL_SIZE: ${REDIS_POOL_SIZE:-12000}
      REDIS_POOL_TIMEOUT: ${REDIS_POOL_TIMEOUT:-240}

      # TLS/HTTPS
      USE_TLS: ${USE_TLS:-false}
      TLS_CERT_FILE: ${TLS_CERT_FILE:-/certs/cert.pem}
      TLS_KEY_FILE: ${TLS_KEY_FILE:-/certs/key.pem}

      # CORS
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-*}
      CORS_ALLOWED_METHODS: ${CORS_ALLOWED_METHODS:-GET,POST,PUT,DELETE,OPTIONS}
      CORS_ALLOWED_HEADERS: ${CORS_ALLOWED_HEADERS:-Accept,Authorization,Content-Type,X-API-Key,X-Request-ID}
      CORS_ALLOW_CREDENTIALS: ${CORS_ALLOW_CREDENTIALS:-true}
      CORS_MAX_AGE: ${CORS_MAX_AGE:-300}

      # Timezone
      TZ: ${TZ:-Asia/Jakarta}

    volumes:
      - ./:/app  # Mount the entire project for hot reload

    depends_on:
      redis:
        condition: service_healthy

    ports:
      - "${SERVER_PORT:-8081}:8081"

    networks:
      - snmp-olt-network

  redis:
    image: redis:7.2-alpine
    container_name: redis-dev
    restart: unless-stopped

    environment:
      TZ: ${TZ:-Asia/Jakarta}

    ports:
      - "${REDIS_PORT:-6379}:6379"

    networks:
      - snmp-olt-network

    volumes:
      - redis-data:/data

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3

networks:
  snmp-olt-network:
    driver: bridge

volumes:
  redis-data:
    driver: local
