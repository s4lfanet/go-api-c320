# Production Docker Compose Configuration
# Uses pre-built image from Docker Hub
#
# Setup:
#   1. Copy .env.example to .env.prod
#   2. Edit .env.prod with production credentials
#   3. Run: docker compose -f docker-compose.prod.yaml --env-file .env.prod up -d
#
# IMPORTANT: Keep .env.prod secure and gitignore

services:
  app:
    image: cepatkilatteknologi/go-snmp-olt-zte-c320:latest
    container_name: snmp-olt-zte-c320-prod
    restart: unless-stopped

    environment:
      # Application
      APP_ENV: ${APP_ENV:-production}

      # Server
      SERVER_HOST: ${SERVER_HOST:-0.0.0.0}
      SERVER_PORT: ${SERVER_PORT:-8081}

      # SNMP Configuration (REQUIRED)
      SNMP_HOST: ${SNMP_HOST}
      SNMP_PORT: ${SNMP_PORT:-161}
      SNMP_COMMUNITY: ${SNMP_COMMUNITY}

      # Redis (use Docker service name)
      REDIS_HOST: redis
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REDIS_DB: ${REDIS_DB:-0}
      REDIS_MIN_IDLE_CONNECTIONS: ${REDIS_MIN_IDLE_CONNECTIONS:-200}
      REDIS_POOL_SIZE: ${REDIS_POOL_SIZE:-12000}
      REDIS_POOL_TIMEOUT: ${REDIS_POOL_TIMEOUT:-240}

      # TLS/HTTPS (Recommended for production)
      USE_TLS: ${USE_TLS:-false}
      TLS_CERT_FILE: ${TLS_CERT_FILE:-/certs/cert.pem}
      TLS_KEY_FILE: ${TLS_KEY_FILE:-/certs/key.pem}

      # CORS (Restrict in production)
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-https://yourdomain.com}
      CORS_ALLOWED_METHODS: ${CORS_ALLOWED_METHODS:-GET,POST,PUT,DELETE,OPTIONS}
      CORS_ALLOWED_HEADERS: ${CORS_ALLOWED_HEADERS:-Accept,Authorization,Content-Type,X-API-Key,X-Request-ID}
      CORS_ALLOW_CREDENTIALS: ${CORS_ALLOW_CREDENTIALS:-true}
      CORS_MAX_AGE: ${CORS_MAX_AGE:-300}

      # Timezone
      TZ: ${TZ:-Asia/Jakarta}

    depends_on:
      redis:
        condition: service_healthy

    ports:
      - "${SERVER_PORT:-8081}:8081"

    networks:
      - snmp-olt-network

    # Mount TLS certificates if using HTTPS
    # volumes:
    #   - ./certs:/certs:ro

    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8081/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  redis:
    image: redis:7.2-alpine
    container_name: redis-prod
    restart: unless-stopped

    environment:
      TZ: ${TZ:-Asia/Jakarta}

    ports:
      - "${REDIS_PORT:-6379}:6379"

    networks:
      - snmp-olt-network

    volumes:
      - redis-data:/data

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

    # Use Redis with password in production (recommended)
    # command: redis-server --requires ${REDIS_PASSWORD}

networks:
  snmp-olt-network:
    driver: bridge

volumes:
  redis-data:
    driver: local
